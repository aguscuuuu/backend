<h1>Panel de Administraci√≥n</h1>

<div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">Filtros</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
        <div>
            <label style="margin-right: 8px;">Categor√≠a:</label>
            <select id="categoryFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;">
                <option value="">Todas</option>
                <option value="Perif√©ricos">Perif√©ricos</option>
                <option value="Monitores">Monitores</option>
                <option value="Audio">Audio</option>
                <option value="Almacenamiento">Almacenamiento</option>
                <option value="Muebles">Muebles</option>
                <option value="Accesorios">Accesorios</option>
            </select>
        </div>

        <div>
            <label style="margin-right: 8px;">Ordenar por precio:</label>
            <select id="sortFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;">
                <option value="">Sin orden</option>
                <option value="asc">Menor a mayor</option>
                <option value="desc">Mayor a menor</option>
            </select>
        </div>

        <div>
            <label style="margin-right: 8px;">Disponibilidad:</label>
            <select id="availabilityFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;">
                <option value="">Todos</option>
                <option value="available">Disponibles</option>
                <option value="unavailable">No disponibles</option>
            </select>
        </div>

        <button onclick="applyFilters()" class="btn">Aplicar filtros</button>
        <button onclick="clearFilters()" class="btn btn-secondary">Limpiar filtros</button>
    </div>
</div>

<div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">Agregar producto</h2>
    <form id="addProductForm" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <input type="text" id="title" placeholder="T√≠tulo" required
            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px">
        
        <input type="text" id="category" placeholder="Categor√≠a" required
            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px">
        
        <textarea id="description" placeholder="Descripci√≥n" required
            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-height: 80px; grid-column: 1 / -1; font-size: 15px"></textarea>
        
        <input type="number" id="price" placeholder="Precio" required min="0" step="0.01"
            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px">
        
        <input type="number" id="stock" placeholder="Stock" required min="0"
            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px">
        
        <button type="submit" class="btn" style="padding: 12px; grid-column: 1 / -1;">‚ûï Agregar Producto</button>
    </form>
</div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Productos (Total: <span id="totalProducts">0</span>)</h2>
    <div id="paginationTop"></div>
</div>

<div id="productsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <p style="color: #888; text-align: center; grid-column: 1/-1;">Cargando productos...</p>
</div>

<div id="paginationBottom" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px;">
</div>

<!-- socket.io client -->
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();
    let currentPage = 1;
    let currentLimit = 12;
    let currentFilters = {};
    let totalPages = 1;

    // cargar productos al conectar
    socket.on('connect', () => {
        console.log('‚úÖ Conectado al servidor');
        requestProducts();
    });

    // recibir lista de productos
    socket.on('updateProducts', (data) => {
        console.log('üì¶ Productos recibidos:', data);
        renderProducts(data.products);
        updatePagination(data.pagination);
    });

    // solicitar productos con filtros y paginaci√≥n
    function requestProducts() {
        socket.emit('requestProducts', {
            page: currentPage,
            limit: currentLimit,
            ...currentFilters
        });
    }

    // renderizar productos
    function renderProducts(products) {
        const container = document.getElementById('productsList');
        document.getElementById('totalProducts').textContent = products.length;
        
        if (products.length === 0) {
            container.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1/-1;">No hay productos</p>';
            return;
        }

        container.innerHTML = products.map(product => `
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white; display: flex; flex-direction: column;">
                ${product.thumbnails && product.thumbnails[0] 
                    ? `<img src="${product.thumbnails[0]}" alt="${product.title}" 
                        style="width: 100%; height: 200px; object-fit: cover; border-radius: 6px; margin-bottom: 12px;">`
                    : `<div style="width: 100%; height: 200px; background: #f2f2f2; border-radius: 6px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
                        Sin imagen
                    </div>`
                }
                
                <h3 style="color: #333; margin-bottom: 10px; font-size: 1.1rem;">${product.title}</h3>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px; min-height: 50px; flex-grow: 1;">${product.description}</p>
                
                <div style="margin-top: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 1.3rem; font-weight: bold; color: #667eea;">$${product.price}</span>
                        <span style="background: ${product.status ? '#28a745' : '#dc3545'}; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.7rem;">
                            ${product.status ? 'Disponible' : 'Agotado'}
                        </span>
                    </div>

                    <p style="color: #666; font-size: 0.8rem; margin-bottom: 5px;">Stock: ${product.stock}</p>
                    <p style="color: #666; font-size: 0.8rem; margin-bottom: 12px;">Categor√≠a: ${product.category}</p>

                    <div style="display: flex; gap: 8px;">
                        <a href="/products/${product._id}" target="_blank" class="btn" style="flex: 1; text-align: center; padding: 8px; font-size: 12px;">
                            Ver detalle
                        </a>
                        <button onclick="deleteProduct('${product._id}')" 
                                style="flex: 1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // actualizar paginaci√≥n
    function updatePagination(pagination) {
        totalPages = pagination.totalPages;
        currentPage = pagination.page;

        const paginationHTML = `
            <button onclick="goToPage(${pagination.page - 1})" 
                    class="btn" ${!pagination.hasPrevPage ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                ‚Üê Anterior
            </button>
            <span style="font-weight: 600; color: #333; margin: 0 15px;">
                ${pagination.page} / ${pagination.totalPages}
            </span>
            <button onclick="goToPage(${pagination.page + 1})" 
                    class="btn" ${!pagination.hasNextPage ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                Siguiente ‚Üí
            </button>
        `;

        document.getElementById('paginationTop').innerHTML = paginationHTML;
        document.getElementById('paginationBottom').innerHTML = paginationHTML;
    }

    // ir a p√°gina
    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        requestProducts();
    }

    // aplicar filtros
    function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const sort = document.getElementById('sortFilter').value;
        const availability = document.getElementById('availabilityFilter').value;

        currentFilters = {};
        if (category) currentFilters.query = category;
        if (availability) currentFilters.query = availability;
        if (sort) currentFilters.sort = sort;

        currentPage = 1;
        requestProducts();
    }

    // limpiar filtros
    function clearFilters() {
        document.getElementById('categoryFilter').value = '';
        document.getElementById('sortFilter').value = '';
        document.getElementById('availabilityFilter').value = '';
        currentFilters = {};
        currentPage = 1;
        requestProducts();
    }

    // agregar producto
    document.getElementById('addProductForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const newProduct = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value),
            stock: parseInt(document.getElementById('stock').value),
            category: document.getElementById('category').value,
            status: true,
            thumbnails: []
        };

        socket.emit('addProduct', newProduct);
        e.target.reset();
    });

    // eliminar producto
    function deleteProduct(id) {
        if (confirm('¬øEliminar este producto?')) {
            socket.emit('deleteProduct', id);
        }
    }

    // mensajes
    socket.on('productAdded', (message) => {
        alert('‚úÖ ' + message);
        currentPage = 1;
        requestProducts();
    });

    socket.on('productDeleted', (message) => {
        alert('‚úÖ ' + message);
        requestProducts();
    });

    socket.on('error', (message) => {
        alert('‚ùå ' + message);
    });
</script>