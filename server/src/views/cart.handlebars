<a href="/products" style="display: inline-block; margin-bottom: 20px; color: #667eea; text-decoration: none;">‚Üê Seguir comprando</a>

<h1>Mi Carrito</h1>

{{#if cart.products.length}}
<div style="margin-bottom: 30px;">
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
        <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 15px; text-align: left;">Producto</th>
                <th style="padding: 15px; text-align: center;">Precio</th>
                <th style="padding: 15px; text-align: center;">Cantidad</th>
                <th style="padding: 15px; text-align: right;">Subtotal</th>
                <th style="padding: 15px; text-align: center;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {{#each cart.products}}
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 15px;">
                    <div>
                        <h4 style="margin-bottom: 5px; color: #333;">{{this.product.title}}</h4>
                        <p style="color: #888; font-size: 0.9rem; margin: 0;">{{this.product.category}}</p>
                    </div>
                </td>
                <td style="padding: 15px; text-align: center; font-weight: bold; color: #667eea;">
                    ${{this.product.price}}
                </td>
                <td style="padding: 15px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <button onclick="updateQuantity('{{this.product._id}}', {{this.quantity}} - 1)" 
                                class="btn btn-secondary" style="padding: 5px 12px;">-</button>
                        <span style="font-weight: bold; min-width: 30px; text-align: center;">{{this.quantity}}</span>
                        <button onclick="updateQuantity('{{this.product._id}}', {{this.quantity}} + 1)" 
                                class="btn btn-secondary" style="padding: 5px 12px;">+</button>
                    </div>
                </td>
                <td style="padding: 15px; text-align: right; font-weight: bold; font-size: 1.1rem;">
                    ${{multiply this.product.price this.quantity}}
                </td>
                <td style="padding: 15px; text-align: center;">
                    <button onclick="removeFromCart('{{this.product._id}}')" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        üóëÔ∏è Eliminar
                    </button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>

    <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; max-width: 400px; margin-left: auto;">
        <h3 style="margin-bottom: 20px; color: #333;">Resumen del pedido</h3>
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6;">
            <span>Subtotal:</span>
            <span style="font-weight: bold;">${{total}}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 1.3rem;">
            <strong>Total:</strong>
            <strong style="color: #667eea;">${{total}}</strong>
        </div>
        <button class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem;">
            üõí Finalizar compra
        </button>
    </div>

    <div style="margin-top: 20px; text-align: right;">
        <button onclick="clearCart()" class="btn btn-secondary">
            üóëÔ∏è Vaciar carrito
        </button>
    </div>
</div>
{{else}}
<div style="text-align: center; padding: 60px 20px;">
    <div style="font-size: 5rem; margin-bottom: 20px;">üõí</div>
    <h2 style="color: #666; margin-bottom: 15px;">Tu carrito est√° vac√≠o</h2>
    <p style="color: #888; margin-bottom: 30px;">Agrega productos para comenzar tu compra</p>
    <a href="/products" class="btn" style="font-size: 1.1rem;">
        Ver productos
    </a>
</div>
{{/if}}

<script>
    const cartId = '{{cart._id}}';

    async function updateQuantity(productId, newQuantity) {
        if (newQuantity < 1) {
            removeFromCart(productId);
            return;
        }

        try {
            const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQuantity })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al actualizar cantidad.');
        }
    }

    async function removeFromCart(productId) {
        if (!confirm('¬øEliminar este producto del carrito?')) return;

        try {
            const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('‚ùå Error al eliminar producto.');
            }
        } catch (error) {
            alert('‚ùå Error al eliminar producto.');
        }
    }

    async function clearCart() {
        if (!confirm('¬øVaciar todo el carrito?')) return;

        try {
            const response = await fetch(`/api/carts/${cartId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                location.reload();
            } else {
                alert('‚ùå Error al vaciar carrito.');
            }
        } catch (error) {
            alert('‚ùå Error al vaciar carrito.');
        }
    }
</script>